#Installing Postgres



yum -y install python-pip python-devel gcc postgresql-server postgresql-devel postgresql-contrib
sudo postgresql-setup initdb

#this will start the PostgreSQL service
systemctl start postgresql

#vim to edit the file.
#vim /var/lib/pgsql/data/pg_hba.conf

#edit the original line.
sed -i 's,host    all             all             127.0.0.1/32            ident,host    all             all             0.0.0.0/0               md5,g'/var/lib/pgsql/data/pg_hba.conf
sed -i 's,host    all             all             ::1/128                 ident,host    all             all             127.0.0.1/32            md5,g'/var/lib/pgsql/data/pg_hba.conf

#restart postgresql
systemctl restart postgresql

#enable postgresql
systemctl enable postgresql

echo "CREATE DATABASE myproject;
CREATE USER myprojectuser WITH PASSWORD 'password';
ALTER ROLE myprojectuser SET client_encoding TO 'utf8';
ALTER ROLE myprojectuser SET default_transaction_isolation TO 'read committed';
ALTER ROLE myprojectuser SET timezone TO 'UTC';
GRANT ALL PRIVILEGES ON DATABASE myproject TO myprojectuser;" >> /tmp/tempfile

#For automatingbring us to sudo su postgres
sudo -u postgres /bin/psql -f /tmp/tempfile




#Install phpPgAdmin
yum -y install httpd
systemctl start httpd.service
systemctl enable httpd.service

#configuring firewall(interact with SELinux for them to interact with other applications)
setsebool -P httpd_can_network_connect on
setsebool -P httpd_can_network_connect_db on



#changing the lines in /var/lib/pgsql/data/postgresql.conf
sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/g" /var/lib/pgsql/data/postgresql.conf
sed -i 's/#port = 5432/port = 5432/g' /var/lib/pgsql/data/postgresql.conf


#creating database for user to remote login
sudo -u postgres /bin/psql -f /tmp/phpmyadmin

#creating an user and password
echo "CREATE USER pgdbuser CREATEDB CREATEUSER ENCRYPTED PASSWORD 'pgdbpass';
CREATE DATABASE mypgdb OWNER pgdbuser;
GRANT ALL PRIVILEGES ON DATABASE mypgdb TO pgdbuser;" > /tmp/phpmyadmin



#Install and Use phpPgAdmin
yum -y install phpPgAdmin

#Change the line in /etc/httpd/conf.d/phpPgAdmin.conf
sed -i 's/Require local/Require all granted/g' /etc/httpd/conf.d/phpPgAdmin.conf
sed -i 's/Deny from all/Allow from all/g' /etc/httpd/conf.d/phpPgAdmin.conf

sed -i "s/$conf\['servers'\]\[0]\['host'] = '';/$conf['servers'][0]['host'] = 'localhost';/g" /etc/phpPgAdmin/config.inc.php
sed -i "s/$conf\['owned_only'\] = false;/$conf['owned_only'] = true;/g" /etc/phpPgAdmin/config.inc.php

systemctl reload httpd.service
systemctl restart postgresql

#ip address from https://34.73.220.235/phpPgAdim
#http://34.73.220.235/phpPgAdmin/

